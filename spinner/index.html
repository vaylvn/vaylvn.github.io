<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vayl Spinner</title>
<style>
  body {font-family: Inter, sans-serif; background:#f6f7f8; color:#222; margin:0; text-align:center;}
  h2,h3{margin:10px 0 5px;}
  #editor{background:white;box-shadow:0 2px 8px rgba(0,0,0,.1);border-radius:8px;
          padding:15px 20px;margin:20px auto;display:inline-block;text-align:left;}
  section{border-top:1px solid #ddd;padding-top:10px;margin-top:10px;}
  label{display:inline-flex;align-items:center;gap:4px;margin:5px 10px 5px 0;}
  input[type=color]{width:40px;height:28px;border:none;background:none;}
  input[type=number],select{height:26px;}
  input[type=range]{width:120px;vertical-align:middle;}
  table{margin-top:8px;border-collapse:collapse;font-size:13px;width:100%;}
  td,th{border:1px solid #ccc;padding:3px 5px;text-align:center;}
  .mini{width:40px;text-align:center;}
  .styleBtn{cursor:pointer;padding:1px 3px;border:1px solid #aaa;border-radius:3px;user-select:none;}
  .styleBtn.active{background:#e0e0e0;}
  #spinnerCanvas{display:block;margin:25px auto 10px;border-radius:50%;background:white;cursor:pointer;}
  #shareUrl{width:80%;}
  #version{font-size:12px;color:#777;position:fixed;bottom:8px;right:10px;}
</style>

<link rel="stylesheet"
 href="https://fonts.googleapis.com/css2?family=Roboto&family=Lato&family=Poppins&family=Montserrat&family=Merriweather&family=Open+Sans&family=Raleway&family=Oswald&family=Playfair+Display&display=swap">
</head>
<body>

<div id="editor">
  <h2>Vayl Spinner Configurator</h2>

  <section>
    <h3>General</h3>
    <label>Auto-spin delay <input type="number" id="spinDelay" min="0" value="0">s</label>
    <label>Auto-spin <input type="checkbox" id="autoSpin"></label><br>
    <label>Spin duration <input type="range" id="spinDuration" min="1000" max="10000" step="250" value="4000">
      <span id="spinDurationVal">4000</span> ms</label>
  </section>

  <section>
    <h3>Global Style</h3>
    <label>Divider color <input type="color" id="dividerColor" value="#ffffff"></label>
    <label>Thickness <input type="range" id="dividerWidth" min="1" max="10" value="2"> <span id="dividerWidthVal">2</span>px</label><br>
    <label>Rim color <input type="color" id="rimColor" value="#000000"></label>
    <label>Thickness <input type="range" id="rimWidth" min="1" max="10" value="3"> <span id="rimWidthVal">3</span>px</label><br>
    <label>Arrow outline <input type="color" id="arrowOutline" value="#ffffff"></label>
    <label>Arrow outline thickness <input type="range" id="arrowWidth" min="1" max="10" value="2"> <span id="arrowWidthVal">2</span>px</label>
  </section>

  <section>
    <h3>Audio</h3>
    <label>Sound
      <select id="soundSelect">
        <option value="none">None</option>
        <option value="click">Click</option>
        <option value="tick">Tick</option>
        <option value="boop">Boop</option>
      </select>
    </label><br>
    <label>Custom URL <input type="text" id="customSoundUrl" placeholder="https://..." style="width:240px"></label><br>
    <label>Tick density <input type="range" id="tickDensity" min="5" max="100" value="30">
      <span id="tickDensityVal">30</span></label>
  </section>

  <section>
    <h3>Segments</h3>
    <table>
      <thead><tr><th>Label</th><th>Color</th><th>Weight</th><th>Font</th><th>Size</th><th>B</th><th>I</th><th>U</th><th></th></tr></thead>
      <tbody id="segments"></tbody>
    </table>
    <button id="addSegment">+ Add Segment</button>
  </section>

  <section>
    <h3>Export / Import</h3>
    <input id="shareUrl" readonly>
    <button id="copyUrl">Copy</button><br>
    <input id="urlImport" placeholder="Paste spinner URL">
    <button id="importUrl">Load</button>
  </section>
</div>

<canvas id="spinnerCanvas" width="400" height="400"></canvas>
<p id="version">v2.4.3</p>

<script>
const GOOGLE_FONTS=["Roboto","Lato","Poppins","Montserrat","Merriweather","Open Sans","Raleway","Oswald","Playfair Display"];
const params=new URLSearchParams(location.search);
const dataParam=params.get("data");
const canvas=document.getElementById("spinnerCanvas");
const ctx=canvas.getContext("2d");
let config={
  spinDelay:0,autoSpin:false,spinDuration:4000,
  dividerColor:"#ffffff",dividerWidth:2,
  rimColor:"#000000",rimWidth:3,
  arrowOutline:"#ffffff",arrowWidth:2,
  sound:"none",customSound:"",tickDensity:30,
  segments:[]
};
let spinning=false,currentRotation=0;

function ensureFontLoaded(font){ if(font) document.fonts.load(`16px '${font}'`).then(()=>drawSpinner(config)); }

/* ---------- Draw Spinner ---------- */
function drawSpinner(cfg,rotation=0){
  currentRotation=rotation;
  const total=cfg.segments.reduce((a,b)=>a+b.weight,0)||1;
  ctx.clearRect(0,0,400,400);
  const radius=200-cfg.rimWidth/2;

  let start=rotation;
  cfg.segments.forEach(seg=>{
    const ang=(seg.weight/total)*2*Math.PI;
    ctx.beginPath();
    ctx.moveTo(200,200);
    ctx.arc(200,200,radius,start,start+ang);
    ctx.closePath();
    ctx.fillStyle=seg.color||"#888";
    ctx.fill();
    const mid=start+ang/2;
    ctx.save(); ctx.translate(200,200); ctx.rotate(mid);
    ctx.textAlign="right";
    const weight=(seg.bold?"bold ":"")+(seg.italic?"italic ":"");
    ctx.font=`${weight}${seg.size||16}px '${seg.font||"sans-serif"}',sans-serif`;
    ctx.fillStyle="#000"; ctx.fillText(seg.label,radius-20,5);
    if(seg.underline){
      const w=ctx.measureText(seg.label).width;
      ctx.beginPath(); ctx.moveTo(radius-20-w,8); ctx.lineTo(radius-20,8);
      ctx.lineWidth=1; ctx.strokeStyle="#000"; ctx.stroke();
    }
    ctx.restore(); start+=ang;
  });

  // dividers
  start=rotation;
  cfg.segments.forEach(seg=>{
    const ang=(seg.weight/total)*2*Math.PI,angle=start+ang;
    ctx.beginPath(); ctx.moveTo(200,200);
    ctx.lineTo(200+radius*Math.cos(angle),200+radius*Math.sin(angle));
    ctx.strokeStyle=cfg.dividerColor; ctx.lineWidth=cfg.dividerWidth; ctx.stroke();
    start+=ang;
  });

  // rim
  ctx.beginPath(); ctx.arc(200,200,radius,0,Math.PI*2);
  ctx.strokeStyle=cfg.rimColor; ctx.lineWidth=cfg.rimWidth; ctx.stroke();

  // arrow color from top segment
  let arrowColor="#000";
  {
    const norm=((rotation%(2*Math.PI))+2*Math.PI)%(2*Math.PI);
    const arrowAngle=(1.5*Math.PI - norm + 2*Math.PI)%(2*Math.PI);
    let cum=0; for(const seg of cfg.segments){
      const segAng=(seg.weight/total)*2*Math.PI;
      if(arrowAngle>=cum && arrowAngle<cum+segAng){arrowColor=seg.color;break;}
      cum+=segAng;
    }
  }
  ctx.beginPath();
  ctx.moveTo(190,0);ctx.lineTo(210,0);ctx.lineTo(200,20);
  ctx.closePath();ctx.fillStyle=arrowColor;ctx.fill();
  ctx.lineWidth=cfg.arrowWidth;ctx.strokeStyle=cfg.arrowOutline;ctx.stroke();
}

/* ---------- Audio Helpers ---------- */
function playSoundOnce(src,vol=0.4){
  try{const a=new Audio(src);a.volume=vol;a.currentTime=0;a.play().catch(()=>{});}catch{}
}

/* ---------- Spin ---------- */
function startSpin(){
  if(spinning||!config.segments.length)return;
  spinning=true;
  const duration=config.spinDuration,startTime=performance.now();
  const startRot=currentRotation,targetRot=startRot+10*Math.PI+Math.random()*Math.PI;

  const sounds={click:"sounds/click.mp3",tick:"sounds/tick.mp3",boop:"sounds/boop.mp3"};
  const chosen=config.customSound||sounds[config.sound];
  const totalTicks=config.tickDensity; let lastTick=-1;

  requestAnimationFrame(function anim(now){
    const p=Math.min((now-startTime)/duration,1);
    const eased=1-Math.pow(1-p,3);
    drawSpinner(config,startRot+eased*(targetRot-startRot));

    const tickIndex=Math.floor(eased*totalTicks);
    if(tickIndex>lastTick){lastTick=tickIndex;
      if(config.sound!=="none"&&chosen) playSoundOnce(chosen,0.35);
    }

    if(p<1)requestAnimationFrame(anim);
    else{spinning=false;
      if(config.sound!=="none"&&chosen) playSoundOnce(chosen,0.5);
    }
  });
}

/* ---------- Editor ---------- */
if(!dataParam){
  const tb=document.getElementById("segments");
  const updateVals=(id,val)=>document.getElementById(id).textContent=val;
  ["dividerWidth","rimWidth","arrowWidth","spinDuration","tickDensity"].forEach(id=>{
    const slider=document.getElementById(id);
    const span=document.getElementById(id+"Val");
    slider.oninput=()=>{updateVals(slider.id+"Val",slider.value);update();};
  });
  ["dividerColor","rimColor","arrowOutline","soundSelect","customSoundUrl"]
    .forEach(id=>document.getElementById(id).oninput=update);

  function fontSelect(v="Roboto"){
    return `<select class="font">${GOOGLE_FONTS.map(f=>`<option${f===v?" selected":""}>${f}</option>`).join("")}</select>`;
  }
  function styleBtn(n,a){return `<span class="styleBtn${a?" active":""}" data-style="${n}">${n[0].toUpperCase()}</span>`;}
  function addRow(seg){
    const r=document.createElement("tr");
    r.innerHTML=`
      <td><input class="label" value="${seg.label}"></td>
      <td><input type="color" class="color" value="${seg.color}"></td>
      <td><input type="number" class="weight" min="1" value="${seg.weight}"></td>
      <td>${fontSelect(seg.font)}</td>
      <td><input type="number" class="size mini" min="8" max="40" value="${seg.size}"></td>
      <td>${styleBtn("bold",seg.bold)}</td>
      <td>${styleBtn("italic",seg.italic)}</td>
      <td>${styleBtn("underline",seg.underline)}</td>
      <td><button class="remove">âœ•</button></td>`;
    tb.appendChild(r);
    r.querySelector(".remove").onclick=()=>{r.remove();update();};
    r.querySelectorAll("input,select").forEach(e=>e.oninput=update);
    r.querySelectorAll(".styleBtn").forEach(b=>b.onclick=()=>{b.classList.toggle("active");update();});
  }

  document.getElementById("addSegment").onclick=()=>{
    const s={label:"",color:"#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0"),
      weight:1,font:"Roboto",size:16,bold:false,italic:false,underline:false};
    addRow(s);update();
  };
  ["spinDelay","autoSpin"].forEach(id=>document.getElementById(id).oninput=update);
  document.getElementById("copyUrl").onclick=()=>navigator.clipboard.writeText(document.getElementById("shareUrl").value);
  document.getElementById("importUrl").onclick=()=>{
    try{
      const u=new URL(document.getElementById("urlImport").value.trim());
      const enc=u.searchParams.get("data");if(!enc)throw 0;
      const cfg=JSON.parse(atob(enc));tb.innerHTML="";Object.assign(config,cfg);
      ["spinDelay","spinDuration","tickDensity","dividerColor","rimColor","arrowOutline"]
        .forEach(id=>{if(config[id]!=null)document.getElementById(id).value=config[id];});
      ["dividerWidth","rimWidth","arrowWidth"].forEach(id=>{
        document.getElementById(id).value=config[id];
        document.getElementById(id+"Val").textContent=config[id];
      });
      document.getElementById("soundSelect").value=config.sound||"none";
      document.getElementById("customSoundUrl").value=config.customSound||"";
      document.getElementById("tickDensityVal").textContent=config.tickDensity;
      config.segments.forEach(addRow);update();
    }catch{alert("Invalid URL");}
  };

  function update(){
    const rows=[...tb.querySelectorAll("tr")];
    config.segments=rows.map(r=>{
      ensureFontLoaded(r.querySelector(".font").value);
      const styles={};r.querySelectorAll(".styleBtn").forEach(b=>styles[b.dataset.style]=b.classList.contains("active"));
      return{
        label:r.querySelector(".label").value,color:r.querySelector(".color").value,
        weight:parseFloat(r.querySelector(".weight").value)||1,
        font:r.querySelector(".font").value,size:parseFloat(r.querySelector(".size").value)||16,...styles
      };
    });
    config.spinDelay=parseFloat(document.getElementById("spinDelay").value)||0;
    config.autoSpin=document.getElementById("autoSpin").checked;
    config.spinDuration=parseFloat(document.getElementById("spinDuration").value)||4000;
    config.dividerColor=document.getElementById("dividerColor").value;
    config.dividerWidth=parseFloat(document.getElementById("dividerWidth").value)||2;
    config.rimColor=document.getElementById("rimColor").value;
    config.rimWidth=parseFloat(document.getElementById("rimWidth").value)||3;
    config.arrowOutline=document.getElementById("arrowOutline").value;
    config.arrowWidth=parseFloat(document.getElementById("arrowWidth").value)||2;
    config.sound=document.getElementById("soundSelect").value;
    config.customSound=document.getElementById("customSoundUrl").value.trim();
    config.tickDensity=parseFloat(document.getElementById("tickDensity").value)||30;
    drawSpinner(config);
    const encoded=btoa(JSON.stringify(config));
    document.getElementById("shareUrl").value=`${location.origin}${location.pathname}?data=${encoded}`;
  }

  addRow({label:"Sample",color:"#ff3b3b",weight:1,font:"Roboto",size:16,bold:false,italic:false,underline:false});
  update(); canvas.onclick=startSpin;

}else{
  document.getElementById("editor").style.display="none";
  try{
    config=JSON.parse(atob(dataParam)); drawSpinner(config); canvas.onclick=startSpin;
    if(config.autoSpin) setTimeout(startSpin,(config.spinDelay??0)*1000);
  }catch{document.body.innerHTML="<h3>Invalid or corrupted spinner data.</h3>";}
}
</script>
</body>
</html>
