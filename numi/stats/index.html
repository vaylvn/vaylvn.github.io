<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>numi – Stats Export</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background:#1B1B1B;
      color:#eee;
      font-family:"IBM Plex Mono", monospace;
      padding:40px;
    }
    button {
      padding:10px 18px;
      font-size:14px;
      background:#1c1c1c;
      border:1px solid #333;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
    }
    button:hover { background:#262626; }
  </style>
</head>
<body>

<h1>numi – Export Stats</h1>
<p>This tool downloads all recorded session data (every user, every run) as a CSV.</p>

<button id="downloadAll">Download Full CSV</button>

<script type="module">
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

  	import {
	  getFirestore, collection, addDoc, getDocs, query,
	  orderBy, limit, doc, writeBatch
	} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";




  // --- SAME CONFIG AS MAIN PAGE ---
  const firebaseConfig = {
    apiKey: "AIzaSyCMD2vQU6sytv_rA46MDh0R7TwF7F8ifTQ",
    authDomain: "quickmath-leaderboard.firebaseapp.com",
    projectId: "quickmath-leaderboard",
    storageBucket: "quickmath-leaderboard.appspot.com",
    messagingSenderId: "514768507939",
    appId: "1:514768507939:web:640e8ceace8a0476e44d96"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- CSV DOWNLOAD LOGIC ---
async function downloadFullCSV() {
    const sessionsSnap = await getDocs(collection(db, "sessions"));

    // Convert Firestore docs → array
    let sessions = sessionsSnap.docs.map(d => ({
        id: d.id,
        ...d.data()
    }));

    // Sort sessions newest → oldest (by timestamp)
    sessions.sort((a, b) => b.timestamp - a.timestamp);

    const rows = [[
        "sessionId",
        "timestamp_ms",
        "timestamp_iso",
        "duration",
        "modeType",
        "min",
        "max",
        "score",
        "attempts",
        "a","b","answer","guess","correct","tEnd","tTaken","isMobile"
    ]];

    for (const s of sessions) {
        const answersSnap = await getDocs(collection(db, `sessions/${s.id}/answers`));

        // Convert answers → array
        let answers = answersSnap.docs.map(aDoc => aDoc.data());

        // Sort smallest → largest time (first to last question)
        answers.sort((a, b) => a.tEnd - b.tEnd);

        const ts_iso = new Date(s.timestamp).toISOString();

        for (const a of answers) {
            rows.push([
                s.id,
                `="${s.timestamp}"`,
                ts_iso,
                s.duration,
                s.modeType,
                s.min,
                s.max,
                s.score,
                s.attempts,
                a.a,
                a.b,
                a.answer,
                a.guess,
                a.correct ? 1 : 0,
                a.tEnd,
                a.tTaken,
				s.isMobile
            ]);
        }
    }

    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "numi_all_sessions.csv";
    a.click();
    URL.revokeObjectURL(url);
}


  document.getElementById("downloadAll").onclick = downloadFullCSV;
</script>

</body>
</html>



