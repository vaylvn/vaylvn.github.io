<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>numi – Stats Export</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background:#1B1B1B;
      color:#eee;
      font-family:"IBM Plex Mono", monospace;
      padding:40px;
    }
    button {
      padding:10px 18px;
      font-size:14px;
      background:#1c1c1c;
      border:1px solid #333;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
    }
    button:hover { background:#262626; }
  </style>
</head>
<body>

<h1>numi – Export Stats</h1>
<p>This tool downloads all recorded session data (every user, every run) as a CSV.</p>

<button id="downloadAll">Download Full CSV</button>

<script type="module">
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

  	import {
	  getFirestore, collection, addDoc, getDocs, query,
	  orderBy, limit, doc, writeBatch
	} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";




  // --- SAME CONFIG AS MAIN PAGE ---
  const firebaseConfig = {
    apiKey: "AIzaSyCMD2vQU6sytv_rA46MDh0R7TwF7F8ifTQ",
    authDomain: "quickmath-leaderboard.firebaseapp.com",
    projectId: "quickmath-leaderboard",
    storageBucket: "quickmath-leaderboard.appspot.com",
    messagingSenderId: "514768507939",
    appId: "1:514768507939:web:640e8ceace8a0476e44d96"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- CSV DOWNLOAD LOGIC ---
  async function downloadFullCSV() {
    const sessionsSnap = await getDocs(collection(db, "sessions"));

    const rows = [
        [
            "sessionId",
            "timestamp_ms",
            "timestamp_iso",
            "duration",
            "modeType",
            "min",
            "max",
            "score",
            "attempts",
            "a", "b", "answer", "guess", "correct", "tEnd", "tTaken"
        ]
    ];

    for (const session of sessionsSnap.docs) {
        const s = session.data();
        const answersSnap = await getDocs(collection(db, `sessions/${session.id}/answers`));

        // prepare timestamp data
        const ts = s.timestamp;
        const ts_text = "'" + ts;                // forces Excel to treat as text
        const ts_iso = new Date(ts).toISOString();

        answersSnap.forEach(aDoc => {
            const a = aDoc.data();
            rows.push([
                session.id,
                `="${s.timestamp}"`,        // text-formatted timestamp
                ts_iso,        // human readable timestamp
                s.duration,
                s.modeType,
                s.min,
                s.max,
                s.score,
                s.attempts,
                a.a,
                a.b,
                a.answer,
                a.guess,
                a.correct ? 1 : 0,
                a.tEnd,
                a.tTaken
            ]);
        });
    }

    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "numi_all_sessions.csv";
    a.click();
    URL.revokeObjectURL(url);
}


  document.getElementById("downloadAll").onclick = downloadFullCSV;
</script>

</body>
</html>
